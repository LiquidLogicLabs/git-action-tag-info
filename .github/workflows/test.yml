name: Test

on:
  workflow_call:  # Called by CI workflow
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read

jobs:
  test:
    # Always run - this workflow only has workflow_call and workflow_dispatch triggers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration

      - name: Run e2e tests
        run: npm run test:e2e

      # Integration tests - Test the action itself
      - name: Test action - Default GITHUB_TOKEN (no token input)
        id: test-default-token
        uses: ./
        with:
          tag_name: latest
          repository: https://github.com/actions/checkout
          # No token provided - should use GITHUB_TOKEN automatically

      - name: Test action - Explicit GITHUB_TOKEN
        id: test-explicit-token
        uses: ./
        with:
          tag_name: latest
          repository: https://github.com/actions/checkout
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Test action - Custom token (if available)
        id: test-custom-token
        uses: ./
        with:
          tag_name: latest
          repository: https://github.com/actions/checkout
          token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
        # Note: To enable this test, add CUSTOM_GITHUB_TOKEN to repository secrets

      - name: Test action - Self-hosted Gitea with ignore_cert_errors
        id: test-self-hosted
        if: ${{ vars.TEST_GITEA_URL != '' }}
        uses: ./
        with:
          tag_name: latest
          repository: https://git.ravenwolf.org/github/traefik
          base_url: https://git.ravenwolf.org
          ignore_cert_errors: true

      - name: Integration test summary
        if: always()
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-default-token.outcome }}" == "success" ]; then
            echo "✅ Default token test: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "  - Tag: ${{ steps.test-default-token.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Default token test: FAILED (may be rate limited)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-explicit-token.outcome }}" == "success" ]; then
            echo "✅ Explicit token test: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "  - Tag: ${{ steps.test-explicit-token.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Explicit token test: FAILED (may be rate limited)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-custom-token.outcome }}" == "success" ]; then
            echo "✅ Custom token test: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "  - Tag: ${{ steps.test-custom-token.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Custom token test: FAILED or not configured" >> $GITHUB_STEP_SUMMARY
            echo "  - To test custom tokens, add CUSTOM_GITHUB_TOKEN to repository secrets" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test-self-hosted.outcome }}" == "success" ]; then
            echo "✅ Self-hosted Gitea test: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "  - Tag: ${{ steps.test-self-hosted.outputs.name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Self-hosted Gitea test: FAILED (may require network access or certificate issues)" >> $GITHUB_STEP_SUMMARY
          fi
